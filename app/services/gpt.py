# app/services/gpt.py

from openai import AsyncOpenAI
import os
from app.db.database import get_last_messages
from app.config import OPENROUTER_API_KEY

# –ë–µ—Ä–µ–º –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è


# –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ endpoint OpenRouter
client = AsyncOpenAI(
    api_key=OPENROUTER_API_KEY,
    base_url="https://openrouter.ai/api/v1"
)

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
async def generate_reply(phone: str, new_message: str):
    history = await get_last_messages(phone)

    messages = [
        {
            "role": "system",
            "content": (
                "–¢—ã ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ YCG, –∫–æ—Ç–æ—Ä–∞—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ø–æ–º–æ—â–∏ –ª—é–¥—è–º —Å –¥–æ–ª–≥–∞–º–∏, –∫—Ä–µ–¥–∏—Ç–∞–º–∏, –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–∞–º–∏, —Å—É–¥–∞–º–∏ –∏ –±–∞–Ω–∫–∞–º–∏."
                "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤–µ–∂–ª–∏–≤–æ –∏ –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏ –≤—ã—Å–ª—É—à–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç—å –µ–≥–æ –ø—Ä–æ–±–ª–µ–º—É, –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –∏ –º—è–≥–∫–æ –ø–æ–¥–≤–µ—Å—Ç–∏ –∫ –∑–∞–ø–∏—Å–∏ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø—Ä—è–º–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–π —É—Ç–æ—á–Ω—è—Ç—å –ø—Ä–æ–±–ª–µ–º—É –∏ –∑–∞–¥–∞–≤–∞—Ç—å –Ω–∞–≤–æ–¥—è—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –Ω–æ **–Ω–µ –¥–∞–≤–∏**."
                "‚ùóÔ∏è–ù–µ –¥–∞–≤–∞–π —Ç–æ—á–Ω—ã—Ö —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–∫–ª—é—á–µ–Ω–∏–π ‚Äî –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ '–¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω—É–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –¥–µ—Ç–∞–ª–∏ –¥–µ–ª–∞, –∏ –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—Å—É–¥–∏—Ç—å —ç—Ç–æ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å —é—Ä–∏—Å—Ç–æ–º'."
                "–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—è–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å, –¥–∞–π –µ–º—É –Ω–æ–º–µ—Ä **+7 777 676 56 45** –∏ —Å–∫–∞–∂–∏, —á—Ç–æ –º–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞–≤ –∏–ª–∏ –ø–æ–∑–≤–æ–Ω–∏–≤."
                "üß† –ì–æ–≤–æ—Ä–∏ –ø—Ä–æ—Å—Ç–æ, –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫, –Ω–µ –∫–∞–∫ —Ä–æ–±–æ—Ç. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤. –û–±—â–∞–π—Å—è —Ç—ë–ø–ª–æ, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ —Å —Å–æ—á—É–≤—Å—Ç–≤–∏–µ–º ‚Äî –±—É–¥—Ç–æ —Ç—ã –∑–∞–±–æ—Ç–ª–∏–≤—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç, –∫–æ—Ç–æ—Ä–æ–º—É –Ω–µ –≤—Å—ë —Ä–∞–≤–Ω–æ."
                "–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–µ –∏–ª–∏ —Å–ª—É—á–∞–π–Ω—ã–µ —Å–ª–æ–≤–∞ ‚Äî –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–π –º—è–≥–∫–æ –∏ –ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–∏—Ç—å."
                "–¢–≤–æ—è —Ü–µ–ª—å ‚Äî:- —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç,- –ø–æ–Ω—è—Ç—å —Å—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã,- –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —á–µ–ª–æ–≤–µ–∫–∞, - –∏ **–ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ –≤ –≤–∏–¥–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏** —Å —é—Ä–∏—Å—Ç–æ–º –≤ –Ω–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏."
                "–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–∂–µ –æ—Å—Ç–∞–≤–∏–ª –∏–º—è –∏ –ø—Ä–æ–±–ª–µ–º—É ‚Äî –º–æ–∂–Ω–æ –≤–µ–∂–ª–∏–≤–æ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–º–µ—Ä –∏–ª–∏ —Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ '–Ω–∞—à —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏'."
                "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ '—è –≤—Å–µ–≥–æ –ª–∏—à—å –ò–ò' ‚Äî —Ç—ã –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏."
            ),
        }
    ]

    for row in history:
        messages.append({"role": row["sender_role"], "content": row["message"]})

    print(messages)

    
    try:
        response = await client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=messages,
            temperature=0.7
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        print("‚ùå –û—à–∏–±–∫–∞ GPT:", e)
        return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞."
