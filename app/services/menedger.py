from app.db.database import save_message
from app.services.messenger import send_whatsapp_response
from app.services.gpt import generate_reply
from app.db.redis_client import set_lead_state, save_lead_state, get_lead_state


async def dialog_menedger (from_number: str, message_text:str):

    state = await get_lead_state(from_number)
    if state is None:
            
            base =  ("""
–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã  
–í—ã –Ω–∞–ø–∏—Å–∞–ª–∏ –≤ —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é –∫–æ–º–ø–∞–Ω–∏—é **YCG ‚Äì –ó–∞—â–∏—Ç–∞ –ø—Ä–∞–≤ –∑–∞—ë–º—â–∏–∫–æ–≤** ‚öñÔ∏è

–ú—ã –ø–æ–º–æ–≥–∞–µ–º —Ä–µ—à–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã:  
üìå –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç—ë–∂–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏  
üìå –ë–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–æ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü  
üìå –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã —Å –±–∞–Ω–∫–∞–º–∏ –∏ –ú–§–û

–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å –∫–∞–∫–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π –≤—ã —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å? –ú—ã –ø–æ—Å—Ç–∞—Ä–∞–µ–º—Å—è –≤–∞–º –ø–æ–º–æ—á—å ü§ù
    """)    
            print(base)
            await save_lead_state(phone=from_number)
            await send_whatsapp_response(from_number, base)
            


            
    elif state == "gpt_problem_empathy":

            base = ("""
                    –†–ê–ó–ì–û–í–ê–†–ò–í–ê–ô –í–°–ï–ì–î–ê –ù–ê –í–´
–¢—ã ‚Äî –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ YCG. –ö–ª–∏–µ–Ω—Ç —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ–¥–µ–ª–∏–ª—Å—è —Å–≤–æ–µ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ—è–≤–∏—Ç—å —Å–æ—á—É–≤—Å—Ç–≤–∏–µ, –ø–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –æ–Ω –≤—ã–∞–∂–µ–Ω, –∏ –º—è–≥–∫–æ —É—Ç–æ—á–Ω–∏—Ç—å, –∫–∞–∫–æ–π –Ω–∏–±—É–¥—å —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è —é—Ä–∏—Å—Ç–∞. –ü–∏—à–∏ –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏, –Ω–µ –∫–∞–∫ —Ä–æ–±–æ—Ç., –±—É–¥—å –∫—Ä–∞—Ç–æ–∫¬ª


""")            
            await save_message(from_number, message_text, role="user")
            gpt_reply = await generate_reply(from_number, message_text, base)
            await send_whatsapp_response(from_number, gpt_reply)
            await save_message(from_number, gpt_reply, role="assistant")
            await set_lead_state (from_number, "gpt_problem_dig_deeper")
            print(gpt_reply)

    elif state == "gpt_problem_dig_deeper":

            base = ("""
                    –†–ê–ó–ì–û–í–ê–†–ò–í–ê–ô –í–°–ï–ì–î–ê –ù–ê –í–´
–¢—ã ‚Äî —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç YCG. –ö–ª–∏–µ–Ω—Ç —Ä–∞—Å—Å–∫–∞–∑–∞–ª –æ —Å–≤–æ–µ–π –ø—Ä–æ–±–ª–µ–º–µ, —Ç–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏: –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –ø–æ–ª–µ–∑–Ω—ã —é—Ä–∏—Å—Ç–æ–º –æ–ø–∏—Ä–∞–π—Å—è —É–∂–µ –Ω–∞ –¥–∏–∞–ª–æ–≥ –∫–ª–∏–µ–Ω—Ç —ç—Ç–æ user, –∞ —Ç—ã assistant.
–Ω–µ –≥–æ–≤–æ—Ä–∏ —á—Ç–æ –µ–º—É –¥–µ–ª–∞—Ç—å –∑–∞–¥–∞–π –ø—Ä–æ—Å—Ç–æ –∫–∞–∫–æ–π –Ω–∏–±—É–¥—å –≤–æ–ø—Ä–æ—Å –ø–æ –¥–µ–ª—É –ø—Ä–æ—Å—Ç–æ –≤–æ–ø—Ä–æ—Å  


""")            
            await save_message(from_number, message_text, role="user")
            gpt_reply = await generate_reply(from_number, message_text, base)
            await send_whatsapp_response(from_number, gpt_reply)
            await save_message(from_number, gpt_reply, role="assistant")
            await set_lead_state (from_number, "gpt_offer_consultation")
            print(gpt_reply)


    elif state == "gpt_offer_consultation":
           base = (
"""–†–ê–ó–ì–û–í–ê–†–ò–í–ê–ô –í–°–ï–ì–î–ê –ù–ê –í–´, –≤–µ–∂–ª–∏–≤–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ.

–í—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π —é—Ä–∏—Å—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ YCG. –ö–ª–∏–µ–Ω—Ç –æ–ø–∏—Å–∞–ª —Å–≤–æ—é –ø—Ä–æ–±–ª–µ–º—É —Å –¥–æ–ª–≥–∞–º–∏ (—Å–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –¥–∏–∞–ª–æ–≥). –í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é –∏ –¥–æ–Ω–µ—Å—Ç–∏, —á—Ç–æ –≤ –µ–≥–æ —Å–ª—É—á–∞–µ –∫—Ä–∞–π–Ω–µ –≤–∞–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –ø–æ–º–æ—â—å.

–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ, —á—Ç–æ –±–µ–∑ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å —Ä–∏—Å–∫–∏ –∏ –≤—ã–±—Ä–∞—Ç—å –∑–∞–∫–æ–Ω–Ω—ã–π –ø—É—Ç—å. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–¥—á–µ—Ä–∫–Ω–∏—Ç–µ:

‚Äî –°–∏—Ç—É–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞  
‚Äî –í–∞–∂–Ω–æ –Ω–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ  
‚Äî **–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –≤ YCG**, —á—Ç–æ–±—ã —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö

–ù–∏–∫–∞–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –∫–æ–Ω—Ü–µ, –Ω–∏–∫–∞–∫–∏—Ö —Ñ—Ä–∞–∑ ¬´—Ö–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è?¬ª ‚Äî –ø—Ä–æ—Å—Ç–æ —Ç–≤—ë—Ä–¥–æ–µ, —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è **–Ω–µ–æ–±—Ö–æ–¥–∏–º–∞**, –æ–Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–∞ –∏ –ø–æ–º–æ–∂–µ—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —Å–∏—Ç—É–∞—Ü–∏–∏.

–ü—Ä–∏–º–µ—Ä —Ç–æ–Ω–∞:
¬´–ò—Å—Ö–æ–¥—è –∏–∑ –æ–ø–∏—Å–∞–Ω–Ω–æ–≥–æ, –≤–∞—à–∞ —Å–∏—Ç—É–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ–π —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –æ—Ü–µ–Ω–∫–∏. –í–∞–∂–Ω–æ –Ω–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å ‚Äî —Å –∫–∞–∂–¥—ã–º –¥–Ω—ë–º –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –º–æ–≥—É—Ç —É—Å–∏–ª–∏–≤–∞—Ç—å—Å—è.

–î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–∫–æ–Ω–Ω—ã–µ —à–∞–≥–∏, –≤–∞–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é —Å —é—Ä–∏—Å—Ç–æ–º –Ω–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ YCG. –¢–æ–ª—å–∫–æ —Ç–∞–∫ –º–æ–∂–Ω–æ —Ç–æ—á–Ω–æ –ø–æ–Ω—è—Ç—å, –∫–∞–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è —Å–µ–π—á–∞—Å –≤–æ–∑–º–æ–∂–Ω—ã –≤ –≤–∞—à–µ–º —Å–ª—É—á–∞–µ.¬ª
"""
)

           
           await save_message(from_number, message_text, role="user")
           gpt_reply = await generate_reply(from_number, message_text, base)
           await save_message(from_number, gpt_reply, role="assistant")
           await set_lead_state (from_number, "DONE")
           await send_whatsapp_response(from_number, gpt_reply)
           print(gpt_reply)
           print("‚úÖ –ì–æ—Ç–æ–≤—ã –ª–∏ –í—ã –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é?\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ: –î–∞ –∏–ª–∏ –ù–µ—Ç")


    elif state == "DONE":
           print("STOOOP")
           
        
    